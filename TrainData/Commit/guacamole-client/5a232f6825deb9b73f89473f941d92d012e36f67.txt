import org.apache.guacamole.GuacamoleAuthenticationRejectedException;
import org.apache.guacamole.GuacamoleSession;
import org.apache.guacamole.net.event.AuthenticationFailureEvent;
import org.apache.guacamole.net.event.AuthenticationSuccessEvent;
import org.apache.guacamole.rest.event.ListenerService;
     * The service to use to notify registered authentication listeners
     */
    @Inject
    private ListenerService listenerService;

    /**
     * Notify all bound AuthenticationSuccessListeners that a successful authentication
     * has occurred. If any of the bound listeners returns false (indicating that the
     * authentication should be rejected) a GuacamoleRejectedAuthenticationException is
     * thrown.
     *
     * @param authenticatedUser
     *      The user that was successfully authenticated
     * @param session
     *      Existing session for the user (if any)
     * @throws GuacamoleException
     *      If a filter throws an exception or if any filter rejects the authentication
     */
    private void notifyAuthenticationSuccessListeners(
            AuthenticatedUser authenticatedUser, GuacamoleSession session)
            throws GuacamoleException {
        UserContext userContext = null;
        if (session != null) {
            userContext = session.getUserContext(
                authenticatedUser.getAuthenticationProvider().getIdentifier());
        }

        AuthenticationSuccessEvent event = new AuthenticationSuccessEvent(
            userContext, authenticatedUser.getCredentials());

        boolean ok = listenerService.authenticationSucceeded(event);
        if (!ok) {
            throw new GuacamoleAuthenticationRejectedException();
        }
    }

    /**
     * Notify all bound AuthenticationFailureListeners that an authentication has failed.
     *
     * @param credentials
     *      The credentials that failed to authenticate
     * @throws GuacamoleException
     *      If a filter throws an exception
     */
    private void notifyAuthenticationFailureListeners(Credentials credentials)
            throws GuacamoleException {
        listenerService.authenticationFailed(new AuthenticationFailureEvent(credentials));
    }

    /**
            if (existingSession != null) {
                AuthenticatedUser updatedUser = updateAuthenticatedUser(
                        existingSession.getAuthenticatedUser(), credentials);
                notifyAuthenticationSuccessListeners(updatedUser, existingSession);
                return updatedUser;
            }
            AuthenticatedUser authenticatedUser = authenticateUser(credentials);
            notifyAuthenticationSuccessListeners(authenticatedUser, null);

            notifyAuthenticationFailureListeners(credentials);

