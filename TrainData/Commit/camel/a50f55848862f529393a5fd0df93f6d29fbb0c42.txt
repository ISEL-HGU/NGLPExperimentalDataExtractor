import java.util.EventObject;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Optional;
import java.util.ServiceLoader;
import java.util.Set;
import com.amazonaws.xray.exceptions.AlreadyEmittedException;
                    try {
                        Subsegment subsegment = AWSXRay.beginSubsegment(sanitizeName(name));
                        sd.pre(subsegment, ese.getExchange(), ese.getEndpoint());
                        LOG.trace("Creating new subsegment with ID {} and name {}",
                                subsegment.getId(), subsegment.getName());
                    } catch (AlreadyEmittedException aeEx) {
                        LOG.warn("Ignoring starting of subsegment "  name  " as its parent segment"
                                 " was already emitted to AWS.");
                    }
                    String name = sd.getOperationName(ese.getExchange(), ese.getEndpoint());
                    try {
                        Subsegment subsegment = AWSXRay.getCurrentSubsegment();
                        sd.post(subsegment, ese.getExchange(), ese.getEndpoint());
                        subsegment.close();
                        LOG.trace("Closing down subsegment with ID {} and name {}",
                                subsegment.getId(), subsegment.getName());
                    } catch (AlreadyEmittedException aeEx) {
                        LOG.warn("Ignoring close of subsegment "  name
                                 " as its parent segment was already emitted to AWS");
                    }
            Optional<Segment> curSegment = AWSXRay.getCurrentSegmentOptional();
            if (!curSegment.isPresent()) {
                String segmentName = curSegment.get().getId();
                try {
                    Subsegment subsegment = AWSXRay.beginSubsegment(route.getId());
                    sd.pre(subsegment, exchange, route.getEndpoint());
                    LOG.trace("Created new XRay subsegment {} with name {}",
                            subsegment.getId(), subsegment.getName());
                } catch (AlreadyEmittedException aeEx) {
                    LOG.warn("Ignoring opening of subsegment "  route.getId()  " as its parent segment "
                             segmentName  " was already emitted before.");
                }
            try {
                SegmentDecorator sd = getSegmentDecorator(route.getEndpoint());
                Optional<Segment> curSegment = AWSXRay.getCurrentSegmentOptional();
                Optional<Subsegment> curSubSegment = AWSXRay.getCurrentSubsegmentOptional();
                if (curSubSegment.isPresent()) {
                    Subsegment subsegment = curSubSegment.get();
                    sd.post(subsegment, exchange, route.getEndpoint());
                    subsegment.close();
                    LOG.trace("Closing down Subsegment {} with name {}",
                            subsegment.getId(), subsegment.getName());
                } else if (curSegment.isPresent()) {
                    Segment segment = curSegment.get();
                    sd.post(segment, exchange, route.getEndpoint());
                    segment.close();
                    LOG.trace("Closing down Segment {} with name {}",
                            segment.getId(), segment.getName());
                }
            } catch (AlreadyEmittedException aeEx) {
                LOG.warn("Ignoring closing of (sub)segment "  route.getId()  " as the segment was already emitted.");
