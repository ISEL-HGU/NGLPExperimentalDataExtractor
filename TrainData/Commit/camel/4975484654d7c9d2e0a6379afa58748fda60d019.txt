        setRecipients(mimeMessage, endpoint.getConfiguration(), exchange);
    private void setRecipients(MimeMessage mimeMessage, MailConfiguration configuration, Exchange exchange) throws MessagingException, IOException {
        // First we check the Message headers for the recipients - they have priority
        boolean toSet = false;
        boolean ccSet = false;
        boolean bccSet = false;
                
                if (Message.RecipientType.TO.toString().equalsIgnoreCase(headerName)) {
                    toSet = true;
                } else if (Message.RecipientType.CC.toString().equalsIgnoreCase(headerName)) {
                    ccSet = true;
                } else if (Message.RecipientType.BCC.toString().equalsIgnoreCase(headerName)) {
                    bccSet = true;
                }
        // Otherwise we check the configuration
        Map<Message.RecipientType, String> recipients = configuration.getRecipients();
        if (!toSet && recipients.containsKey(Message.RecipientType.TO)) {
            appendRecipientToMimeMessage(mimeMessage, configuration, exchange, Message.RecipientType.TO.toString(), recipients.get(Message.RecipientType.TO));
        if (!ccSet && recipients.containsKey(Message.RecipientType.CC)) {
            appendRecipientToMimeMessage(mimeMessage, configuration, exchange, Message.RecipientType.CC.toString(), recipients.get(Message.RecipientType.CC));
        if (!bccSet && recipients.containsKey(Message.RecipientType.BCC)) {
            appendRecipientToMimeMessage(mimeMessage, configuration, exchange, Message.RecipientType.BCC.toString(), recipients.get(Message.RecipientType.BCC));
