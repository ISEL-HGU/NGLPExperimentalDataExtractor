        Object ret = null;
        try {
            ret = decode(exchange, encodedDocument, keyEncryptionKey, true);
        } catch (org.apache.xml.security.encryption.XMLEncryptionException ex) {
            if (ex.getMessage().equals("encryption.nokey")) {
                //the message don't have EncryptionKey, try key directly
                ret = decode(exchange, encodedDocument, keyEncryptionKey, false);
            } else {
                throw ex;
            }
        }
        return  ret;
        Object ret = null;
        try {
            ret = decode(exchange, encodedDocument, keyEncryptionKey, true);
        } catch (org.apache.xml.security.encryption.XMLEncryptionException ex) {
            if (ex.getMessage().equals("encryption.nokey")) {
                //the message don't have EncryptionKey, try key directly
                ret = decode(exchange, encodedDocument, keyEncryptionKey, false);
            } else {
                throw ex;
            }
        }
        return  ret;
    private Object decode(Exchange exchange, Document encodedDocument, Key keyEncryptionKey,
                          boolean hasEncrytionKey) throws Exception {
        if (hasEncrytionKey) {
            xmlCipher.init(XMLCipher.DECRYPT_MODE, null);
            xmlCipher.setKEK(keyEncryptionKey);
        } else {
            xmlCipher.init(XMLCipher.DECRYPT_MODE, keyEncryptionKey);
        }
